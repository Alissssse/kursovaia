{% extends 'main/base.html' %}

{% block title %}Список маршрутов{% endblock %}

{% block content %}
<h1 class="mb-4">Список маршрутов</h1>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Фильтры</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">Поиск</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ current_filters.search }}" placeholder="Поиск по названию или описанию">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="location" class="form-label">Местоположение</label>
                        <input type="text" class="form-control" id="location" name="location" 
                               value="{{ current_filters.location }}" placeholder="Введите местоположение">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="min_price" class="form-label">Цена от</label>
                        <input type="number" class="form-control" id="min_price" name="min_price" 
                               value="{{ current_filters.min_price }}" placeholder="Мин. цена">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="max_price" class="form-label">Цена до</label>
                        <input type="number" class="form-control" id="max_price" name="max_price" 
                               value="{{ current_filters.max_price }}" placeholder="Макс. цена">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="duration" class="form-label">Длительность</label>
                        <select class="form-select" id="duration" name="duration">
                            <option value="">Любая длительность</option>
                            {% for value, label in duration_choices %}
                                <option value="{{ value }}" {% if current_filters.duration == value|stringformat:"i" %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="created_after" class="form-label">Создан после</label>
                        <input type="date" class="form-control" id="created_after" name="created_after" 
                               value="{{ current_filters.created_after }}">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="created_before" class="form-label">Создан до</label>
                        <input type="date" class="form-control" id="created_before" name="created_before" 
                               value="{{ current_filters.created_before }}">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="rating" class="form-label">Мин. рейтинг</label>
                        <input type="number" class="form-control" id="rating" name="rating" 
                               value="{{ current_filters.rating }}" min="1" max="5" step="0.1" placeholder="Рейтинг">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="name_starts_with" class="form-label">Название начинается с</label>
                        <input type="text" class="form-control" id="name_starts_with" name="name_starts_with" 
                               value="{{ current_filters.name_starts_with }}" placeholder="Первые буквы">
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Популярные длительности</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="duration1" name="popular_durations" value="1"
                                   {% if '1' in current_filters.popular_durations %}checked{% endif %}>
                            <label class="form-check-label" for="duration1">1 час</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="duration2" name="popular_durations" value="2"
                                   {% if '2' in current_filters.popular_durations %}checked{% endif %}>
                            <label class="form-check-label" for="duration2">2 часа</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="duration4" name="popular_durations" value="4"
                                   {% if '4' in current_filters.popular_durations %}checked{% endif %}>
                            <label class="form-check-label" for="duration4">4 часа</label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Исключить туры (примеры exclude)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hide_expensive" name="hide_expensive" value="1"
                                           {% if current_filters.hide_expensive %}checked{% endif %}>
                                    <label class="form-check-label" for="hide_expensive">Скрыть дорогие (>10000)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hide_without_reviews" name="hide_without_reviews" value="1"
                                           {% if current_filters.hide_without_reviews %}checked{% endif %}>
                                    <label class="form-check-label" for="hide_without_reviews">Скрыть без отзывов</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hide_new" name="hide_new" value="1"
                                           {% if current_filters.hide_new %}checked{% endif %}>
                                    <label class="form-check-label" for="hide_new">Скрыть новые (7 дней)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="highly_rated" name="highly_rated" value="1"
                                           {% if current_filters.highly_rated %}checked{% endif %}>
                                    <label class="form-check-label" for="highly_rated">Только с высоким рейтингом</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="exclude_duration" class="form-label">Исключить длительность</label>
                                <select class="form-select" id="exclude_duration" name="exclude_duration">
                                    <option value="">Не исключать</option>
                                    {% for value, label in duration_choices %}
                                        <option value="{{ value }}" {% if current_filters.exclude_duration == value|stringformat:"i" %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="exclude_location" class="form-label">Исключить местоположение</label>
                                <input type="text" class="form-control" id="exclude_location" name="exclude_location" 
                                       value="{{ current_filters.exclude_location }}" placeholder="Местоположение">
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 text-end">
                        <a href="{% url 'tour_list' %}" class="btn btn-secondary me-2">Сбросить</a>
                        <button type="submit" class="btn btn-primary">Применить фильтры</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Список туров</h2>
            <div>
                <a href="{% url 'tour_create' %}" class="btn btn-success">
                    <i class="bi bi-plus-circle me-1"></i>Создать тур
                </a>
                <a href="{% url 'bulk_tour_actions' %}" class="btn btn-warning">
                    <i class="bi bi-gear me-1"></i>Массовые операции
                </a>
            </div>
        </div>
    </div>
    
    {% for tour in tours %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">{{ tour.name }}</h5>
                    <p class="card-text">{{ tour.description|truncatewords:30 }}</p>
                    <p class="card-text">Длительность: {{ tour.get_duration_display }}</p>
                    <p class="card-text">Цена: {{ tour.price }} руб.</p>
                    <p class="card-text text-muted small">
                        <i class="bi bi-calendar"></i> Создан: {{ tour.created_at|date:"d.m.Y" }}<br>
                        <i class="bi bi-clock"></i> Возраст: {{ tour.get_age }} дн.
                        {% if tour.was_recently_updated %}
                            <span class="badge bg-info ms-2">Недавно обновлен</span>
                        {% endif %}
                        {% if tour.is_highly_rated %}
                            <span class="badge bg-success ms-2">Высокий рейтинг</span>
                        {% endif %}
                    </p>
                    <div class="btn-group">
                        <a href="{% url 'tour_edit' tour.pk %}" class="btn btn-warning">Редактировать</a>
                        <a href="{% url 'tour_delete' tour.pk %}" class="btn btn-danger">Удалить</a>
                    </div>
                    <div class="mt-2">
                        <a href="{% url 'create_review' tour.pk %}" class="btn btn-info">Добавить отзыв</a>
                    </div>
                </div>
            </div>
        </div>
    {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                <p>Маршрутов не найдено. {% if request.GET %}Попробуйте изменить параметры фильтрации.{% endif %}</p>
            </div>
        </div>
    {% endfor %}
</div>

{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="First">
                    &laquo;&laquo;
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Previous">
                    &laquo;
                </a>
            </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Next">
                    &raquo;
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Last">
                    &raquo;&raquo;
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %} 